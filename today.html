<!DOCTYPE html>
<html lang="en">
<head>
<script data-goatcounter="https://ethereousnatsudragneel.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
<meta charset="UTF-8">
<title>Freid – Today's Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<h1>Freid – Today's Challenge</h1>

<p>
  One puzzle per day. Everyone gets the same word.
  You have six attempts.
</p>

<div id="streak"></div>

<div id="history">
  <h2 id="attempt1"></h2>
  <p id="attempt1feedback" aria-live="polite"></p>

  <h2 id="attempt2"></h2>
  <p id="attempt2feedback" aria-live="polite"></p>

  <h2 id="attempt3"></h2>
  <p id="attempt3feedback" aria-live="polite"></p>

  <h2 id="attempt4"></h2>
  <p id="attempt4feedback" aria-live="polite"></p>

  <h2 id="attempt5"></h2>
  <p id="attempt5feedback" aria-live="polite"></p>

  <h2 id="attempt6"></h2>
  <p id="attempt6feedback" aria-live="polite"></p>
</div>

<div id="status" style="margin-top:1rem;"></div>
<p id="afterGame" style="margin-top:1.5rem;"></p>

<label for="guessInput">Enter your guess:</label><br>
<input id="guessInput" type="text" maxlength="5" aria-label="Enter a 5 letter word">
<button id="submitBtn">Enter</button>

<script>
(() => {
  const USE_MOCK_DATE = false;
  function getNow() {
    return USE_MOCK_DATE
      ? new Date("2026-01-21T12:00:00")
      : new Date();
  }

  let words = [];
  let safeWords = [];
  let answer = "";
  let attemptsLeft = 6;
  let attemptNumber = 0;
  let usedWords = new Set();
  let gameOver = false;

  const guessInput = document.getElementById("guessInput");
  const submitBtn = document.getElementById("submitBtn");
  const statusDiv = document.getElementById("status");
  const streakDiv = document.getElementById("streak");
  const afterGame = document.getElementById("afterGame");

  const today = getTodayString();
  const todayResultKey = "freid-daily-result-" + today;
  const todayStateKey  = "freid-daily-state-" + today;
  const streakKey = "freid-streak";

  const bannedPatterns = [
    /cunt/i, /clit/i, /orgasm/i, /fuck/i, /shit/i,
    /bitch/i, /whore/i, /slut/i, /nigger/i,
    /faggot/i, /rape/i, /cock/i, /dick/i,
    /pussy/i, /asshole/i
  ];

  fetch("words.txt")
    .then(r => r.text())
    .then(text => {
      words = text.split(/\r?\n/).map(w => w.trim().toLowerCase());
      safeWords = words.filter(w => !bannedPatterns.some(rx => rx.test(w)));
      if (!safeWords.length) safeWords = words;
      initDailyGame();
    });

  function initDailyGame() {
    enforceStreakDecay();

    answer = pickDailyWord();
    updateStreakDisplay();

    const finalResult = localStorage.getItem(todayResultKey);
    if (finalResult) {
      endGameDisplay(JSON.parse(finalResult).result, true);
      return;
    }

    const savedState = localStorage.getItem(todayStateKey);
    if (savedState) {
      restoreState(JSON.parse(savedState));
      return;
    }

    statusDiv.textContent = "Today's puzzle loaded. You have 6 attempts.";
  }

  function enforceStreakDecay() {
    const data = JSON.parse(localStorage.getItem(streakKey) || "{}");

    if (
      data.count > 0 &&
      data.lastWinDate !== getYesterdayString() &&
      data.lastWinDate !== today
    ) {
      localStorage.setItem(
        streakKey,
        JSON.stringify({ count: 0, lastWinDate: null })
      );
      alert("Sadly, your streak has been broken.");
    }
  }

  function stringToSeed(str) {
    let h = 2166136261;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function mulberry32(seed) {
    return function () {
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function pickDailyWord() {
    const seed = stringToSeed(today);
    const rand = mulberry32(seed);
    return safeWords[Math.floor(rand() * safeWords.length)];
  }

  function getTodayString() {
    const d = getNow();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function submitGuess() {
    if (gameOver) return;

    const guess = guessInput.value.toLowerCase().trim();

    if (guess.length !== 5 || !words.includes(guess)) {
      alert("please enter a valid 5-letter word");
      return;
    }

    if (usedWords.has(guess)) {
      alert("you have already used this word");
      return;
    }

    usedWords.add(guess);
    attemptNumber++;
    attemptsLeft--;

    renderFeedback(guess);
    saveState();

    if (guess === answer) return handleWin();
    if (attemptsLeft === 0) return handleLoss();

    statusDiv.textContent = "Attempts remaining: " + attemptsLeft;
    guessInput.value = "";
    guessInput.focus();
  }

  function renderFeedback(guess) {
    const header = document.getElementById("attempt" + attemptNumber);
    const feedback = document.getElementById("attempt" + attemptNumber + "feedback");

    header.textContent = "Attempt " + attemptNumber + ": " + guess;

    const letterCounts = {};
    for (let c of answer) {
      letterCounts[c] = (letterCounts[c] || 0) + 1;
    }

    const lines = [];

    for (let i = 0; i < 5; i++) {
      const result =
        guess[i] === answer[i] ? "correct." :
        letterCounts[guess[i]] > 0 ? "present in another position." :
        "absent.";

      if (guess[i] === answer[i] || letterCounts[guess[i]] > 0) {
        letterCounts[guess[i]]--;
      }

      lines.push(guess[i] + ": " + result);
    }

    feedback.innerHTML = lines.join("<br>");
  }

  function saveState() {
    localStorage.setItem(todayStateKey, JSON.stringify({
      attemptsLeft,
      attemptNumber,
      usedWords: [...usedWords],
      historyHTML: document.getElementById("history").innerHTML,
      gameOver
    }));
  }

  function restoreState(state) {
    attemptsLeft = state.attemptsLeft;
    attemptNumber = state.attemptNumber;
    usedWords = new Set(state.usedWords);
    document.getElementById("history").innerHTML = state.historyHTML;
    gameOver = state.gameOver;
    statusDiv.textContent = "Attempts remaining: " + attemptsLeft;
  }

  function handleWin() {
    saveDailyResult("win");
    updateStreak(true);
    cleanupState();
    endGameDisplay("win");
  }

  function handleLoss() {
    saveDailyResult("loss");
    updateStreak(false);
    alert("Sadly, your streak has been broken.");
    cleanupState();
    endGameDisplay("loss");
  }

  function saveDailyResult(result) {
    localStorage.setItem(todayResultKey, JSON.stringify({ result }));
  }

  function cleanupState() {
    localStorage.removeItem(todayStateKey);
  }

  function updateStreak(won) {
    let data = JSON.parse(localStorage.getItem(streakKey) || "{}");

    if (!won) {
      data = { count: 0, lastWinDate: null };
    } else {
      data.count =
        data.lastWinDate === getYesterdayString()
          ? (data.count || 0) + 1
          : 1;
      data.lastWinDate = today;
    }

    localStorage.setItem(streakKey, JSON.stringify(data));
    updateStreakDisplay();
  }

  function getYesterdayString() {
    const d = getNow();
    d.setDate(d.getDate() - 1);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  function updateStreakDisplay() {
    const data = JSON.parse(localStorage.getItem(streakKey) || "{}");
    streakDiv.textContent =
      data.count ? `Current streak: ${data.count}` : "No active streak.";
  }

  function endGameDisplay(result, alreadyPlayed = false) {
    gameOver = true;
    guessInput.disabled = true;
    submitBtn.disabled = true;

    statusDiv.textContent =
      result === "win"
        ? alreadyPlayed ? "You already solved today's puzzle." : "Congratulations! You solved today's puzzle."
        : "No attempts left. The word was " + answer + ".";

    afterGame.innerHTML =
      `Want more? <a href="game.html">Play unlimited mode</a>.`;
  }

  submitBtn.addEventListener("click", submitGuess);
  guessInput.addEventListener("keydown", e => e.key === "Enter" && submitGuess());
})();
</script>

</body>
</html>
